# FROM neo4j:latest
# COPY ./neo4j.conf /var/lib/neo4j/conf/neo4j.conf


# # Install Python and pip
# RUN apt-get update && apt-get install -y --fix-missing python3 python3-pip netcat

# ENV NEO4JLABS_PLUGINS=["graph-data-science"]

# RUN pip install flask==3.0.2 neo4j==5.17.0 gunicorn==21.2.0


# COPY ./db_api.py ./db_api.py
# COPY ./db_utils.py ./db_utils.py



# CMD exec neo4j start & while ! nc -z localhost 7687; do sleep 1; done && python3 db_utils.py && gunicorn --bind :80 --workers 1 --threads 8 db_api:app 


FROM neo4j:latest

# Set environment variable for GDS plugin - use specific version if needed
ENV NEO4JLABS_PLUGINS='["graph-data-science"]'

# Copy configuration
COPY ./neo4j.conf /var/lib/neo4j/conf/neo4j.conf

# Install Python and pip
RUN apt-get update && apt-get install -y --fix-missing python3 python3-pip netcat
RUN pip install flask==3.0.2 neo4j==5.17.0 gunicorn==21.2.0

# Copy Python files
COPY ./db_api.py ./db_api.py
COPY ./db_utils.py ./db_utils.py

# Create a startup script
RUN echo '#!/bin/bash\n\
neo4j start\n\
while ! nc -z localhost 7687; do sleep 1; done\n\
python3 db_utils.py\n\
exec gunicorn --bind :80 --workers 1 --threads 8 db_api:app\n\
' > /start.sh && chmod +x /start.sh

# Use the startup script as the entry point
CMD ["/start.sh"]
